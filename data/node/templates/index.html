<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>노드 추가 지도</title>
    <style>
        [id^=map_] {
            display: block;   /* 기본값 inline-block일 수 있으니 block으로 */
            margin: 20px auto; /* 위아래 20px, 좌우 자동 → 가운데 정렬 */
        }
        #coordForm {
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- folium이 생성한 leaflet 코드 직접 삽입 -->
    {{ map_html|safe }}

    <!-- 좌표 저장 폼 -->
    <form method="POST" action="/" id="coordForm">
        <input type="hidden" name="lat" id="lat">
        <input type="hidden" name="lon" id="lon">
        <button type="submit">저장</button>
    </form>

    <script>
        let pendingNodes = [];

        // 이제 iframe이 없으므로 바로 window.map 사용 가능
        map.on("click", function (e) {
            let lat = e.latlng.lat.toFixed(7);
            let lon = e.latlng.lng.toFixed(7);

            L.popup()
                .setLatLng(e.latlng)
                .setContent("Lat: " + lat + "<br>Lon: " + lon)
                .openOn(map);

            pendingNodes.push({lat: lat, lon: lon});
            console.log("좌표 추가됨:", lat, lon);
            console.log("현재 pendingNodes 배열:", pendingNodes);
        });

        document.getElementById("coordForm").addEventListener("submit", function (e) {
            e.preventDefault();

            if (pendingNodes.length === 0) {
                alert("저장할 노드가 없습니다!");
                return;
            }

            fetch("/save_nodes", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({nodes: pendingNodes})
            })
            .then(res => res.json())
            .then(data => {
                console.log("저장 완료:", data);
                pendingNodes = [];
                location.reload();
            });
        });
    </script>
</body>
</html>
